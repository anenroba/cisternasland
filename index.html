<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cisternas 2039 - Carta Digital</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="left">
      <button id="themeToggle" aria-label="Cambiar tema">üåô</button>
    </div>
    <div class="center">
      <h1>Cisternas 2039</h1>
    </div>
    <div class="right">
      Mesa: <strong id="mesaLabel">0</strong>
    </div>
  </header>

  <!-- Categor√≠as principales + carrito -->
  <div class="top-bar">
    <div class="category-buttons">
      <button id="btnDrink" class="category-btn" data-cat="drink">Drink</button>
      <button id="btnFood" class="category-btn active" data-cat="food">Food</button>
    </div>
    <button id="cartButton" style="display:none">üõí<span id="cartCount">0</span></button>
  </div>

  <!-- Subcategor√≠as -->
  <section class="subcategory-menu">
    <div class="subcategory-container" id="subcategoryContainer"></div>
  </section>

  <!-- Productos -->
  <main id="productsSection">
    <div id="productsContainer"></div>
    <div id="loadingIndicator" style="display:none">Cargando...</div>
  </main>

  <!-- Modal carrito -->
  <div id="cartModal" class="cart-modal">
    <div class="cart-content">
      <div class="cart-header">
        <strong>Carrito</strong>
        <button id="closeCart">‚úñ</button>
      </div>
      <div id="cartItems" class="cart-items"></div>
      <div class="cart-footer">
        <button id="clearCart">Vaciar Carrito</button>
        <button id="sendOrder">Enviar Pedido</button>
      </div>
    </div>
  </div>

  <div id="notification" class="notification"></div>

<script>
const API_URL = 'https://api-swa.onrender.com/api/carta';
const PEDIDOS_URL = 'https://api-swa.onrender.com/api/pedidos';

let cartaData = [];
let currentCategory = 'food';
let cart = [];
let sectionObserver = null; // ‚úÖ FIX: declarada arriba

const mesaParam = new URLSearchParams(window.location.search).get('mesa');
const isCatalogMode = !mesaParam || isNaN(mesaParam);
document.getElementById('mesaLabel').textContent = isCatalogMode ? '0' : mesaParam;
if (!isCatalogMode) document.getElementById('cartButton').style.display = 'block';

// Tema claro/oscuro
const themeToggle = document.getElementById('themeToggle');
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark') document.body.classList.add('dark');
themeToggle.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  const dark = document.body.classList.contains('dark');
  localStorage.setItem('theme', dark ? 'dark' : 'light');
  themeToggle.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
});

function formatPrice(n){ return '$' + Number(n).toLocaleString('es-CL'); }
function showNotification(msg, bgColor='black'){
  const not = document.getElementById('notification');
  not.style.background = bgColor;
  not.textContent = msg;
  not.style.display = 'block';
  setTimeout(()=> not.style.display = 'none', 2500);
}

// Cache local
const CACHE_KEY = 'cisternas_carta';
const CACHE_EXPIRY_KEY = 'cisternas_carta_expiry';
const CACHE_DURATION = 24 * 60 * 60 * 1000;
function isCacheValid(){ const exp = localStorage.getItem(CACHE_EXPIRY_KEY); return exp && Date.now() < Number(exp); }
function getCache(){ if(!isCacheValid()) return null; try{ return JSON.parse(localStorage.getItem(CACHE_KEY)); }catch(e){ return null; } }
function saveCache(data){ localStorage.setItem(CACHE_KEY, JSON.stringify(data)); localStorage.setItem(CACHE_EXPIRY_KEY, (Date.now()+CACHE_DURATION).toString()); }

async function fetchCartaData(){
  document.getElementById('loadingIndicator').style.display = 'block';
  try{
    const res = await fetch(API_URL);
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    cartaData = data;
    saveCache(data);
    renderAll();
  }catch(err){
    showNotification('No se pudo cargar la carta', 'crimson');
    const cached = getCache();
    if(cached){
      cartaData = cached;
      renderAll();
    }
  }finally{
    document.getElementById('loadingIndicator').style.display = 'none';
  }
}

const cached = getCache();
if(cached){ cartaData = cached; renderAll(); }
fetchCartaData().catch(()=>{});

function getCategoryType(cat){
  const drinks = ['Botellas','Cervezas','Cocteler√≠a','Gin','Licores','Pisco','Ron','Sin alcohol','Tequila','Vinos & Espumantes','Vodka','Whisky','Degustaciones'];
  return drinks.some(d => d.toLowerCase() === (cat||'').toLowerCase()) ? 'drink' : 'food';
}

function renderSubcategories(){
  const subContainer = document.getElementById('subcategoryContainer');
  subContainer.innerHTML = '';
  const subs = Array.from(new Set(
    cartaData
      .filter(i => getCategoryType(i.categoria) === currentCategory)
      .map(i => String(i.subcategoria || '').trim())
      .filter(Boolean)
  ));
  subs.sort((a,b)=>{
    const la = a.toLowerCase();
    const lb = b.toLowerCase();
    if(la === 'dulce final') return 1;
    if(lb === 'dulce final') return -1;
    return la.localeCompare(lb, 'es');
  });
  subs.forEach(sub=>{
    const btn = document.createElement('button');
    btn.className = 'subcategory-btn';
    btn.textContent = sub;
    btn.addEventListener('click', ()=> {
      document.getElementById(idFromSub(sub))?.scrollIntoView({behavior:'smooth', block:'start'});
    });
    subContainer.appendChild(btn);
  });
}

function idFromSub(sub){
  return 'sub-' + encodeURIComponent(sub).replace(/%/g,'');
}

function renderProducts(){
  const container = document.getElementById('productsContainer');
  container.innerHTML = '';
  const grouped = {};
  cartaData
    .filter(i => getCategoryType(i.categoria) === currentCategory)
    .forEach(item => {
      const sub = String(item.subcategoria || '').trim();
      if(!grouped[sub]) grouped[sub] = [];
      (item.productos || []).forEach(p => grouped[sub].push(p));
    });
  const subKeys = Object.keys(grouped).filter(Boolean).sort((a,b)=>{
    const la = a.toLowerCase();
    const lb = b.toLowerCase();
    if(la === 'dulce final') return 1;
    if(lb === 'dulce final') return -1;
    return la.localeCompare(lb, 'es');
  });
  subKeys.forEach(sub=>{
    const sec = document.createElement('section');
    sec.id = idFromSub(sub);
    sec.className = 'product-subcategory-section';
    const title = document.createElement('h2');
    title.className = 'subcategory-section-title';
    title.textContent = sub;
    sec.appendChild(title);
    const grid = document.createElement('div');
    grid.className = 'products-grid';
    grouped[sub].forEach(prod=>{
      const card = document.createElement('article');
      card.className = 'product-card';
      const header = document.createElement('div');
      header.className = 'product-header';
      const nameDiv = document.createElement('div');
      nameDiv.className = 'product-name';
      nameDiv.textContent = prod.nombre || '';
      header.appendChild(nameDiv);
      if(!isCatalogMode){
        const add = document.createElement('button');
        add.className = 'add-btn';
        add.innerHTML = '+';
        add.addEventListener('click', ()=> addToCart(prod));
        header.appendChild(add);
      }
      card.appendChild(header);
      const price = document.createElement('div');
      price.className = 'product-price';
      price.textContent = formatPrice(prod.precio || 0);
      card.appendChild(price);
      grid.appendChild(card);
    });
    sec.appendChild(grid);
    container.appendChild(sec);
  });
  setupObserverForSubcategories(); // ‚úÖ Se llama despu√©s de crear secciones
}

function setupObserverForSubcategories(){
  if (sectionObserver) sectionObserver.disconnect();
  const buttons = Array.from(document.querySelectorAll('.subcategory-btn'));
  const sections = Array.from(document.querySelectorAll('.product-subcategory-section'));
  if(sections.length === 0) return;
  sectionObserver = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if(entry.isIntersecting){
        const id = entry.target.id;
        buttons.forEach(btn => {
          const targetId = idFromSub(btn.textContent);
          const active = targetId === id;
          btn.classList.toggle('active', active);
          if(active){
            btn.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
          }
        });
      }
    });
  }, {threshold: 0.35, root: null, rootMargin: '-20% 0px -50% 0px'});
  sections.forEach(s => sectionObserver.observe(s));
}

function renderAll(){
  renderSubcategories();
  renderProducts();
}

function addToCart(prod){
  const ex = cart.find(it => Number(it.id) === Number(prod.id));
  if(ex) ex.quantity++;
  else cart.push({ id: prod.id, nombre: prod.nombre, precio: prod.precio, quantity: 1 });
  renderCartCount();
}

function renderCartCount(){
  document.getElementById('cartCount').textContent = cart.reduce((s,i)=> s + (i.quantity||0), 0);
}
function renderCartModal(){
  const cartItemsEl = document.getElementById('cartItems');
  cartItemsEl.innerHTML = '';
  if(cart.length === 0){
    cartItemsEl.innerHTML = '<div style="padding:18px;color:var(--muted)">Carrito vac√≠o</div>';
    return;
  }
  cart.forEach(it=>{
    const row = document.createElement('div');
    row.className = 'cart-item';
    row.innerHTML = `<div>${it.nombre} x${it.quantity} - ${formatPrice(it.precio * it.quantity)}</div>
      <div><button onclick="removeFromCart(${it.id})">üóëÔ∏è</button></div>`;
    cartItemsEl.appendChild(row);
  });
}
window.removeFromCart = function(id){
  cart = cart.filter(i => Number(i.id) !== Number(id));
  renderCartModal();
  renderCartCount();
};

if(!isCatalogMode){
  document.getElementById('cartButton').addEventListener('click', ()=>{
    renderCartModal();
    document.getElementById('cartModal').classList.add('active');
  });
  document.getElementById('closeCart').addEventListener('click', ()=> {
    document.getElementById('cartModal').classList.remove('active');
  });
  document.getElementById('clearCart').addEventListener('click', ()=>{
    if(confirm('Vaciar carrito?')){ cart = []; renderCartModal(); renderCartCount(); }
  });
  document.getElementById('sendOrder').addEventListener('click', async ()=>{
    if(cart.length === 0){ alert('Carrito vac√≠o'); return; }
    const payload = {
      table_number: Number(mesaParam),
      items: cart.map(i => ({ product_id: Number(i.id), quantity: i.quantity }))
    };
    try{
      const res = await fetch(PEDIDOS_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error('Error ' + res.status);
      showNotification('Pedido enviado', 'green');
      cart = [];
      renderCartModal(); renderCartCount();
      document.getElementById('cartModal').classList.remove('active');
    }catch(err){
      showNotification('No se pudo enviar el pedido', 'crimson');
    }
  });
}

document.getElementById('btnDrink').addEventListener('click', ()=>{
  currentCategory = 'drink';
  document.getElementById('btnDrink').classList.add('active');
  document.getElementById('btnFood').classList.remove('active');
  renderAll();
});
document.getElementById('btnFood').addEventListener('click', ()=>{
  currentCategory = 'food';
  document.getElementById('btnFood').classList.add('active');
  document.getElementById('btnDrink').classList.remove('active');
  renderAll();
});
</script>
</body>
</html>
