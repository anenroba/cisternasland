<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Cisternas 2039 - Carta Digital</title>
<style>
* {margin:0;padding:0;box-sizing:border-box;}
body {
  font-family: Arial, sans-serif;
  background: var(--bg, #f5f6fa);
  color: var(--text, #222);
  transition: background 0.3s, color 0.3s;
}
:root {
  --primary: #4a69bd;
  --secondary: #44bd32;
  --bg: #f5f6fa;
  --text: #222;
  --card-bg: #fff;
}
body.dark {
  --bg: #1e272e;
  --text: #f1f2f6;
  --card-bg: #2f3640;
}

/* ==== Header ==== */
header {
  background: var(--card-bg);
  padding: 0.5rem 1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  position: sticky;
  top:0;
  z-index: 100;
}
header h1 {
  font-size: 1.2rem;
  white-space: nowrap;
}
header .left,
header .right {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.theme-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.2rem;
}

/* ==== Top bar (Drink/Food + carrito) ==== */
.top-bar {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  padding: 0.5rem 1rem;
  position: sticky;
  top: 56px;
  background: var(--card-bg);
  z-index: 90;
}
.category-buttons {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
}
.category-buttons button {
  padding: 0.4rem 1rem;
  border: none;
  border-radius: 20px;
  background: #dcdde1;
  cursor: pointer;
  font-weight: bold;
}
.category-buttons button.active {
  background: var(--primary);
  color: #fff;
}
.cart-btn {
  justify-self: end;
  position: relative;
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.5rem;
}
.cart-count {
  position: absolute;
  top: -6px;
  right: -6px;
  background: var(--secondary);
  color: white;
  font-size: 0.7rem;
  padding: 2px 6px;
  border-radius: 50%;
}

/* ==== Subcategories ==== */
.subcategories {
  display: flex;
  gap: 0.4rem;
  overflow-x: auto;
  padding: 0.5rem;
  background: var(--card-bg);
  position: sticky;
  top: 108px;
  z-index: 80;
}
.subcategories button {
  padding: 0.3rem 0.6rem;
  border: none;
  border-radius: 15px;
  background: #f1f2f6;
  cursor: pointer;
  white-space: nowrap;
}
.subcategories button.active {
  background: var(--primary);
  color: white;
}

/* ==== Products ==== */
.products-container {
  padding: 1rem;
}
.subcategory-block {
  margin-bottom: 1rem;
}
.subcategory-title {
  font-size: 1.1rem;
  margin-bottom: 0.5rem;
}
.product-card {
  background: var(--card-bg);
  border-radius: 8px;
  padding: 0.8rem;
  box-shadow: 0 0 6px rgba(0,0,0,0.05);
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}
.product-info {
  flex: 1;
}
.product-name {
  font-weight: bold;
}
.product-price {
  color: var(--secondary);
}
.add-btn {
  background: var(--primary);
  color: white;
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  font-size: 1.2rem;
  cursor: pointer;
}

/* ==== Modal Cart ==== */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
}
.modal-content {
  background: var(--card-bg);
  color: var(--text);
  border-radius: 8px;
  width: 90%;
  max-width: 400px;
  padding: 1rem;
}
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.modal-header h2 { margin: 0; }
.cart-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 0.5rem 0;
}
.modal-actions {
  display: flex;
  justify-content: space-between;
  margin-top: 1rem;
}
.btn-danger {
  background: #e84118;
  color: white;
  padding: 0.4rem 0.8rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
.btn-success {
  background: var(--secondary);
  color: white;
  padding: 0.4rem 0.8rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
</style>
</head>
<body>
<header>
  <div class="left">
    <button class="theme-btn" id="theme-toggle">🌙</button>
  </div>
  <h1>Cisternas 2039</h1>
  <div class="right">
    <span id="mesa-label">Mesa: 0</span>
  </div>
</header>

<div class="top-bar">
  <div></div>
  <div class="category-buttons">
    <button id="category-drink">Drink</button>
    <button id="category-food" class="active">Food</button>
  </div>
  <button class="cart-btn" id="open-cart" style="display:none;">🛒<span class="cart-count" id="cart-count">0</span></button>
</div>

<div id="subcategories" class="subcategories"></div>

<div class="products-container" id="products-container"></div>

<!-- Modal del carrito -->
<div class="modal" id="cart-modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Carrito</h2>
      <button id="close-cart">✖</button>
    </div>
    <div id="cart-items"></div>
    <div class="modal-actions">
      <button class="btn-danger" id="empty-cart">Vaciar Carrito</button>
      <button class="btn-success" id="send-order">Enviar Pedido</button>
    </div>
  </div>
</div>

<script>
const API_URL = 'https://api-swa.onrender.com/api/carta';
const PEDIDOS_URL = 'https://api-swa.onrender.com/api/pedidos';
let currentCategory = 'food';
let cartaData = [];
let cart = [];

// Mesa y modo
const mesaParam = new URLSearchParams(window.location.search).get('mesa');
const isCatalogMode = !mesaParam || isNaN(mesaParam);
document.getElementById('mesa-label').textContent = `Mesa: ${isCatalogMode ? 0 : mesaParam}`;
if (!isCatalogMode) document.getElementById('open-cart').style.display = 'block';

// === Tema oscuro/claro ===
const themeBtn = document.getElementById('theme-toggle');
if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
themeBtn.textContent = document.body.classList.contains('dark') ? '☀️' : '🌙';
themeBtn.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  const darkMode = document.body.classList.contains('dark');
  localStorage.setItem('theme', darkMode ? 'dark' : 'light');
  themeBtn.textContent = darkMode ? '☀️' : '🌙';
});

// === Cargar carta desde localStorage si existe ===
function loadFromLocalStorage() {
  const stored = localStorage.getItem('cartaData');
  if (stored) {
    cartaData = JSON.parse(stored);
    renderSubcategories();
    renderProducts();
  }
}
async function fetchCarta() {
  try {
    const res = await fetch(API_URL);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    cartaData = await res.json();
    localStorage.setItem('cartaData', JSON.stringify(cartaData));
    renderSubcategories();
    renderProducts();
  } catch (err) {
    console.error('Error cargando carta:', err);
    if (!cartaData.length) alert('No se pudo cargar la carta.');
  }
}

function getCategoryType(categoria) {
  const drinks = ['Botellas','Cervezas','Coctelería','Gin','Licores','Pisco','Ron','Tequila','Vodka','Vinos & Espumantes','Whisky','Sin alcohol','Degustaciones'];
  return drinks.includes(categoria) ? 'drink' : 'food';
}

function renderSubcategories() {
  let subs = [...new Set(cartaData.filter(i => getCategoryType(i.categoria) === currentCategory).map(i => i.subcategoria))];
  if (currentCategory === 'food' && subs.includes('Dulce final')) {
    subs = subs.filter(s => s !== 'Dulce final').concat('Dulce final');
  }
  const subCont = document.getElementById('subcategories');
  subCont.innerHTML = '';
  subs.forEach(sub => {
    const btn = document.createElement('button');
    btn.textContent = sub;
    btn.addEventListener('click', () => {
      document.getElementById(sub).scrollIntoView({ behavior: 'smooth' });
    });
    subCont.appendChild(btn);
  });
}

function renderProducts() {
  const container = document.getElementById('products-container');
  container.innerHTML = '';
  const grouped = {};

  cartaData.filter(i => getCategoryType(i.categoria) === currentCategory).forEach(item => {
    if (!grouped[item.subcategoria]) grouped[item.subcategoria] = [];
    grouped[item.subcategoria].push(...item.productos);
  });

  let subKeys = Object.keys(grouped);
  if (currentCategory === 'food' && subKeys.includes('Dulce final')) {
    subKeys = subKeys.filter(s => s !== 'Dulce final').concat('Dulce final');
  }

  for (const sub of subKeys) {
    const block = document.createElement('div');
    block.classList.add('subcategory-block');
    block.id = sub;
    const title = document.createElement('div');
    title.classList.add('subcategory-title');
    title.textContent = sub;
    block.appendChild(title);

    grouped[sub].forEach(prod => {
      const card = document.createElement('div');
      card.classList.add('product-card');
      card.innerHTML = `
        <div class="product-info">
          <div class="product-name">${prod.nombre}</div>
          <div class="product-price">$${prod.precio}</div>
        </div>
        ${!isCatalogMode ? `<button class="add-btn">+</button>` : ''}
      `;
      if (!isCatalogMode) {
        card.querySelector('.add-btn').addEventListener('click', () => addToCart(prod));
      }
      block.appendChild(card);
    });

    container.appendChild(block);
  }
  observeSections();
}

function observeSections() {
  const buttons = document.querySelectorAll('#subcategories button');
  const sections = document.querySelectorAll('.subcategory-block');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        buttons.forEach(b => {
          const isActive = b.textContent === entry.target.id;
          b.classList.toggle('active', isActive);
          if (isActive) {
            b.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
          }
        });
      }
    });
  }, { threshold: 0.3 });
  sections.forEach(sec => observer.observe(sec));
}

function addToCart(prod) {
  const existing = cart.find(p => p.id === prod.id);
  if (existing) existing.quantity++;
  else cart.push({ ...prod, quantity: 1 });
  updateCartCount();
}

function updateCartCount() {
  document.getElementById('cart-count').textContent = cart.reduce((sum, p) => sum + p.quantity, 0);
}

const cartModal = document.getElementById('cart-modal');
document.getElementById('open-cart').addEventListener('click', () => {
  renderCartModal();
  cartModal.style.display = 'flex';
});
document.getElementById('close-cart').addEventListener('click', () => {
  cartModal.style.display = 'none';
});
document.getElementById('empty-cart').addEventListener('click', () => {
  if (confirm('¿Vaciar carrito?')) {
    cart = [];
    updateCartCount();
    renderCartModal();
  }
});
function renderCartModal() {
  const cont = document.getElementById('cart-items');
  cont.innerHTML = '';
  cart.forEach(item => {
    const div = document.createElement('div');
    div.classList.add('cart-item');
    div.innerHTML = `
      <span>${item.nombre} x${item.quantity} - $${item.precio * item.quantity}</span>
      <button onclick="removeFromCart(${item.id})">🗑️</button>
    `;
    cont.appendChild(div);
  });
}
window.removeFromCart = function(id) {
  cart = cart.filter(p => p.id !== id);
  updateCartCount();
  renderCartModal();
}

document.getElementById('send-order').addEventListener('click', async () => {
  if (cart.length === 0) return alert('Carrito vacío');
  const payload = { table_number: parseInt(mesaParam), items: cart.map(i => ({ product_id: i.id, quantity: i.quantity })) };
  try {
    const res = await fetch(PEDIDOS_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
    if (res.ok) {
      alert('Pedido enviado');
      cart = [];
      updateCartCount();
      cartModal.style.display = 'none';
    } else {
      alert('Error al enviar pedido');
    }
  } catch (err) {
    console.error('Error enviando pedido:', err);
    alert('Error de conexión');
  }
});

document.getElementById('category-food').addEventListener('click', () => {
  currentCategory = 'food';
  document.getElementById('category-food').classList.add('active');
  document.getElementById('category-drink').classList.remove('active');
  renderSubcategories();
  renderProducts();
});
document.getElementById('category-drink').addEventListener('click', () => {
  currentCategory = 'drink';
  document.getElementById('category-drink').classList.add('active');
  document.getElementById('category-food').classList.remove('active');
  renderSubcategories();
  renderProducts();
});

// Cargar datos
loadFromLocalStorage();
fetchCarta();
</script>
</body>
</html>
