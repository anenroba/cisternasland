<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Cisternas 2039 - Carta Digital</title>
<style>
/* ---------- Reset & variables ---------- */
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --accent:#4361ee;
  --accent-hover:#3a56d4;
  --bg:#f8f9fa;
  --card:#ffffff;
  --text:#212529;
  --muted:#6c757d;
  --price:#2a9d8f;
  --shadow:0 4px 6px rgba(0,0,0,0.08);
  --success:#2a9d8f;
  --error:#e63946;
}
body{font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background:var(--bg); color:var(--text); line-height:1.5;}
body.dark{
  --bg:#121212; --card:#1e1e1e; --text:#f8f9fa; --muted:#adb5bd; --shadow:0 4px 6px rgba(0,0,0,0.4);
}

/* ---------- Header ---------- */
.header{position:sticky;top:0;z-index:120;background:var(--card);box-shadow:var(--shadow);padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
.header .left,.header .center,.header .right{display:flex;align-items:center;gap:10px}
.header .center{justify-content:center;flex:1}
.header h1{font-size:1.15rem;white-space:nowrap;margin:0}

/* theme button */
.theme-toggle{background:none;border:0;font-size:1.25rem;cursor:pointer;padding:6px;border-radius:8px}

/* ---------- Top bar: categories + cart ---------- */
.top-bar{position:sticky;top:56px;z-index:110;background:var(--card);padding:10px 16px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center}
.category-buttons{display:flex;gap:10px;justify-content:center}
.category-btn{background:#e9ecef;border:0;padding:8px 18px;border-radius:30px;cursor:pointer;font-weight:700}
.category-btn.active{background:var(--accent);color:#fff}
.cart-btn{justify-self:end;background:none;border:0;cursor:pointer;font-size:1.4rem;position:relative;padding:6px;border-radius:8px}
.cart-count{position:absolute;top:-6px;right:-6px;background:var(--success);color:#fff;font-size:0.75rem;padding:2px 6px;border-radius:20px;display:flex;align-items:center;justify-content:center}

/* ---------- Subcategories (sticky) ---------- */
.subcategory-menu{position:sticky;top:110px;z-index:100;background:var(--card);padding:10px 10px;border-bottom:1px solid rgba(0,0,0,0.04);overflow:hidden}
.subcategory-container{display:flex;gap:8px;overflow-x:auto;padding-bottom:6px;scroll-behavior:smooth}
.subcategory-btn{white-space:nowrap;border:0;padding:8px 14px;border-radius:24px;background:#f1f3f5;cursor:pointer}
.subcategory-btn.active{background:var(--accent);color:#fff}

/* ---------- Products ---------- */
.products-section{padding:18px}
.product-subcategory-section{margin-bottom:36px}
.subcategory-section-title{font-size:1.25rem;font-weight:700;margin:8px 0 12px;padding-bottom:6px;border-bottom:2px solid var(--accent);scroll-margin-top:180px}
.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px}
.product-card{background:var(--card);border-radius:12px;padding:12px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:8px}
.product-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.product-name{font-weight:700}
.product-price{color:var(--price);font-weight:800;margin-top:4px}
.add-btn{width:40px;height:40px;border-radius:50%;border:0;background:var(--accent);color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* ---------- Cart modal ---------- */
.cart-modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:200;align-items:center;justify-content:center;padding:18px}
.cart-modal.active{display:flex}
.cart-content{width:100%;max-width:520px;background:var(--card);border-radius:12px;overflow:hidden;display:flex;flex-direction:column;max-height:85vh}
.cart-header{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid rgba(0,0,0,0.06)}
.cart-items{padding:12px;overflow:auto;flex:1}
.cart-item{display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--bg);border-radius:10px;margin-bottom:8px}
.cart-footer{padding:12px;border-top:1px solid rgba(0,0,0,0.06);display:flex;gap:10px}
.btn{padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
.btn-clear{background:#f1f3f5;color:var(--text)}
.btn-send{background:var(--success);color:white}

/* ---------- Loading/notification ---------- */
.loading{display:flex;justify-content:center;padding:30px}
.notification{position:fixed;right:18px;bottom:18px;padding:12px 16px;border-radius:8px;color:#fff;z-index:300;display:none}

/* ---------- Responsive ---------- */
@media(max-width:720px){
  .products-grid{grid-template-columns:1fr}
  .header{padding:10px}
  .top-bar{top:56px}
}
</style>
</head>
<body>
  <!-- HEADER -->
  <header class="header" role="banner">
    <div class="left">
      <button id="themeToggle" class="theme-toggle" aria-label="Cambiar tema">üåô</button>
    </div>
    <div class="center">
      <h1>Cisternas 2039</h1>
    </div>
    <div class="right">
      <div>Mesa: <strong id="mesaLabel">0</strong></div>
    </div>
  </header>

  <!-- TOP: Drink / Food centered + cart right -->
  <div class="top-bar">
    <div></div>
    <div class="category-buttons" role="tablist" aria-label="Categor√≠as">
      <button id="btnDrink" class="category-btn" data-cat="drink">Drink</button>
      <button id="btnFood" class="category-btn active" data-cat="food">Food</button>
    </div>
    <button id="cartButton" class="cart-btn" title="Abrir carrito" style="display:none">üõí<span id="cartCount" class="cart-count">0</span></button>
  </div>

  <!-- Subcategories (sticky) -->
  <section class="subcategory-menu" aria-label="Subcategor√≠as">
    <div class="subcategory-container" id="subcategoryContainer"></div>
  </section>

  <!-- Products -->
  <main class="products-section" id="productsSection" role="main">
    <div id="productsContainer"></div>
    <div id="loadingIndicator" class="loading" style="display:none">Cargando...</div>
  </main>

  <!-- Cart modal -->
  <div id="cartModal" class="cart-modal" aria-hidden="true">
    <div class="cart-content" role="dialog" aria-modal="true" aria-label="Carrito de pedidos">
      <div class="cart-header">
        <strong>Carrito</strong>
        <button id="closeCart" aria-label="Cerrar">‚úñ</button>
      </div>
      <div id="cartItems" class="cart-items"></div>
      <div class="cart-footer">
        <button id="clearCart" class="btn btn-clear">Vaciar Carrito</button>
        <button id="sendOrder" class="btn btn-send">Enviar Pedido</button>
      </div>
    </div>
  </div>

  <div id="notification" class="notification"></div>

<script>
/* ===========================
   Config / Estado inicial
   =========================== */
const API_URL = 'https://api-swa.onrender.com/api/carta';
const PEDIDOS_URL = 'https://api-swa.onrender.com/api/pedidos';

let cartaData = [];            // raw api array (unchanged)
let currentCategory = 'food';  // default view
let cart = [];

// Mesa / modo cat√°logo
const mesaParam = new URLSearchParams(window.location.search).get('mesa');
const isCatalogMode = !mesaParam || isNaN(mesaParam);
document.getElementById('mesaLabel').textContent = isCatalogMode ? '0' : mesaParam;
if (!isCatalogMode) document.getElementById('cartButton').style.display = 'block';

/* ===========================
   Tema oscuro / localStorage
   =========================== */
const themeToggle = document.getElementById('themeToggle');
const savedTheme = localStorage.getItem('theme');
if (savedTheme === 'dark') document.body.classList.add('dark');
themeToggle.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark');
  const dark = document.body.classList.contains('dark');
  localStorage.setItem('theme', dark ? 'dark' : 'light');
  themeToggle.textContent = dark ? '‚òÄÔ∏è' : 'üåô';
});

/* ===========================
   Utilidades
   =========================== */
function formatPrice(n){ return '$' + Number(n).toLocaleString('es-CL'); }
function showNotification(msg, bgColor='black'){
  const not = document.getElementById('notification');
  not.style.background = bgColor;
  not.textContent = msg;
  not.style.display = 'block';
  setTimeout(()=> not.style.display = 'none', 2500);
}

/* ===========================
   Caching: localStorage
   =========================== */
const CACHE_KEY = 'cisternas_carta';
const CACHE_EXPIRY_KEY = 'cisternas_carta_expiry';
const CACHE_DURATION = 24 * 60 * 60 * 1000;

function isCacheValid(){
  const exp = localStorage.getItem(CACHE_EXPIRY_KEY);
  return exp && Date.now() < Number(exp);
}
function getCache(){
  if(!isCacheValid()) return null;
  try{ return JSON.parse(localStorage.getItem(CACHE_KEY)); }catch(e){ return null; }
}
function saveCache(data){
  localStorage.setItem(CACHE_KEY, JSON.stringify(data));
  localStorage.setItem(CACHE_EXPIRY_KEY, (Date.now()+CACHE_DURATION).toString());
}

/* ===========================
   Fetch / carga de carta
   =========================== */
async function fetchCartaData(){
  document.getElementById('loadingIndicator').style.display = 'block';
  try{
    const res = await fetch(API_URL);
    if(!res.ok) throw new Error('HTTP ' + res.status);
    const data = await res.json();
    cartaData = data;
    saveCache(data);
    renderSubcategories();
    renderProducts();
  }catch(err){
    console.error('fetchCartaData error', err);
    showNotification('No se pudo cargar la carta', 'crimson');
    const cached = getCache();
    if(cached){
      cartaData = cached;
      renderSubcategories();
      renderProducts();
    }
  }finally{
    document.getElementById('loadingIndicator').style.display = 'none';
  }
}

/* Try load cache first for snappiness */
const cached = getCache();
if(cached){ cartaData = cached; renderSubcategories(); renderProducts(); }
/* Then fetch fresh data in background */
fetchCartaData().catch(()=>{});

/* ===========================
   Map API category -> drink/food
   =========================== */
function getCategoryType(cat){
  const drinks = ['Botellas','Cervezas','Cocteler√≠a','Gin','Licores','Pisco','Ron','Sin alcohol','Tequila','Vinos & Espumantes','Vodka','Whisky','Degustaciones'];
  return drinks.some(d => d.toLowerCase() === (cat||'').toLowerCase()) ? 'drink' : 'food';
}

/* ===========================
   RENDER Subcategories
   - uses sort to move "Dulce Final" to the end (case-insensitive)
   =========================== */
function renderSubcategories(){
  const subContainer = document.getElementById('subcategoryContainer');
  subContainer.innerHTML = '';

  // build unique list of subcategory names (strings)
  const subs = Array.from(new Set(
    cartaData
      .filter(i => getCategoryType(i.categoria) === currentCategory)
      .map(i => String(i.subcategoria || '').trim())
      .filter(Boolean)
  ));

  // sort alphabetically but force "dulce final" last (case-insensitive)
  subs.sort((a,b)=>{
    const la = a.toLowerCase();
    const lb = b.toLowerCase();
    if(la === 'dulce final') return 1;
    if(lb === 'dulce final') return -1;
    return la.localeCompare(lb, 'es');
  });

  subs.forEach((sub, idx)=>{
    const btn = document.createElement('button');
    btn.className = 'subcategory-btn';
    btn.textContent = sub;
    btn.type = 'button';
    btn.addEventListener('click', ()=> {
      // scroll to target section (id is sanitized to match created sections)
      const id = idFromSub(sub);
      const section = document.getElementById(id);
      if(section) section.scrollIntoView({behavior:'smooth', block:'start'});
    });
    subContainer.appendChild(btn);
  });
}

/* ===========================
   Helper: create safe id for subcategory names
   =========================== */
function idFromSub(sub){
  // remove spaces/accents -> simple transform
  return 'sub-' + encodeURIComponent(sub).replace(/%/g,'');
}

/* ===========================
   RENDER Products
   - groups by subcategory and uses same sort to keep Dulce Final last
   =========================== */
function renderProducts(){
  const container = document.getElementById('productsContainer');
  container.innerHTML = '';

  // Group products by subcategory (string key)
  const grouped = {};
  cartaData
    .filter(i => getCategoryType(i.categoria) === currentCategory)
    .forEach(item => {
      const sub = String(item.subcategoria || '').trim();
      if(!grouped[sub]) grouped[sub] = [];
      // push each producto object
      (item.productos || []).forEach(p => grouped[sub].push(p));
    });

  // keys and sort them forcing Dulce Final last
  const subKeys = Object.keys(grouped).filter(Boolean).sort((a,b)=>{
    const la = a.toLowerCase();
    const lb = b.toLowerCase();
    if(la === 'dulce final') return 1;
    if(lb === 'dulce final') return -1;
    return la.localeCompare(lb, 'es');
  });

  subKeys.forEach(sub => {
    const sec = document.createElement('section');
    const secId = idFromSub(sub);
    sec.id = secId;
    sec.className = 'product-subcategory-section';

    const title = document.createElement('h2');
    title.className = 'subcategory-section-title';
    title.textContent = sub;
    sec.appendChild(title);

    const grid = document.createElement('div');
    grid.className = 'products-grid';

    grouped[sub].forEach(prod => {
      const card = document.createElement('article');
      card.className = 'product-card';
      // product layout: header (name + add) and price below
      const header = document.createElement('div');
      header.className = 'product-header';

      const nameDiv = document.createElement('div');
      nameDiv.className = 'product-name';
      nameDiv.textContent = prod.nombre || '';

      header.appendChild(nameDiv);

      if(!isCatalogMode){
        const add = document.createElement('button');
        add.className = 'add-btn';
        add.type = 'button';
        add.title = 'Agregar';
        add.innerHTML = '+';
        add.addEventListener('click', ()=> addToCart(prod));
        header.appendChild(add);
      }

      card.appendChild(header);

      const price = document.createElement('div');
      price.className = 'product-price';
      price.textContent = formatPrice(prod.precio || 0);
      card.appendChild(price);

      // optional description
      if(prod.descripcion){
        const desc = document.createElement('div');
        desc.style.color = 'var(--muted)';
        desc.style.marginTop = '6px';
        desc.textContent = prod.descripcion;
        card.appendChild(desc);
      }

      grid.appendChild(card);
    });

    sec.appendChild(grid);
    container.appendChild(sec);
  });

  // after rendering, setup observer so subcategory buttons follow scroll
  setupObserverForSubcategories();
}

/* ===========================
   IntersectionObserver: highlights active subcategory and scrolls subcategory menu
   =========================== */
let sectionObserver = null;
function setupObserverForSubcategories(){
  if(sectionObserver) sectionObserver.disconnect();

  const buttons = Array.from(document.querySelectorAll('.subcategory-btn'));
  const sections = Array.from(document.querySelectorAll('.product-subcategory-section'));
  if(sections.length === 0) return;

  const subContainer = document.getElementById('subcategoryContainer');

  sectionObserver = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if(entry.isIntersecting){
        const id = entry.target.id;
        // find matching button by comparing sanitized ids
        buttons.forEach(btn => {
          const targetId = idFromSub(btn.textContent);
          const active = targetId === id;
          btn.classList.toggle('active', active);
          if(active){
            // center the active button in the horizontal subcategory scroller
            btn.scrollIntoView({behavior:'smooth', inline:'center', block:'nearest'});
          }
        });
      }
    });
  }, {threshold: 0.35, root: null, rootMargin: '-20% 0px -50% 0px'});

  sections.forEach(s => sectionObserver.observe(s));
}

/* ===========================
   CART logic (modal)
   =========================== */
const cartButton = document.getElementById('cartButton');
const cartCountEl = document.getElementById('cartCount');
const cartModal = document.getElementById('cartModal');
const cartItemsEl = document.getElementById('cartItems');
const closeCart = document.getElementById('closeCart');
const clearCartBtn = document.getElementById('clearCart');
const sendOrderBtn = document.getElementById('sendOrder');

function addToCart(prod){
  // find by id
  const ex = cart.find(it => Number(it.id) === Number(prod.id));
  if(ex) ex.quantity++;
  else cart.push({ id: prod.id, nombre: prod.nombre, precio: prod.precio, quantity: 1 });
  renderCartCount();
}

function renderCartCount(){
  const total = cart.reduce((s,i)=> s + (i.quantity||0), 0);
  cartCountEl.textContent = total;
}
function renderCartModal(){
  cartItemsEl.innerHTML = '';
  if(cart.length === 0){
    cartItemsEl.innerHTML = '<div style="padding:18px;color:var(--muted)">Carrito vac√≠o</div>';
    return;
  }
  cart.forEach(it=>{
    const row = document.createElement('div');
    row.className = 'cart-item';
    row.innerHTML = `<div>${it.nombre} x${it.quantity} - ${formatPrice(it.precio * it.quantity)}</div>
      <div><button style="background:none;border:0;cursor:pointer" aria-label="Eliminar" onclick="removeFromCart(${it.id})">üóëÔ∏è</button></div>`;
    cartItemsEl.appendChild(row);
  });
}

// make remove accessible globally (simple)
window.removeFromCart = function(id){
  cart = cart.filter(i => Number(i.id) !== Number(id));
  renderCartModal();
  renderCartCount();
};

if(!isCatalogMode){
  cartButton.addEventListener('click', ()=>{
    renderCartModal();
    cartModal.classList.add('active');
    cartModal.setAttribute('aria-hidden','false');
  });
  closeCart.addEventListener('click', ()=> {
    cartModal.classList.remove('active');
    cartModal.setAttribute('aria-hidden','true');
  });
  clearCartBtn.addEventListener('click', ()=>{
    if(confirm('Vaciar carrito?')){
      cart = [];
      renderCartModal();
      renderCartCount();
    }
  });

  sendOrderBtn.addEventListener('click', async ()=>{
    if(cart.length === 0){ alert('Carrito vac√≠o'); return; }
    const payload = {
      table_number: Number(mesaParam),
      items: cart.map(i => ({ product_id: Number(i.id), quantity: i.quantity }))
    };
    try{
      sendOrderBtn.disabled = true;
      const res = await fetch(PEDIDOS_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if(!res.ok) throw new Error('Error ' + res.status);
      showNotification('Pedido enviado', 'green');
      cart = [];
      renderCartModal(); renderCartCount();
      cartModal.classList.remove('active');
    }catch(err){
      console.error(err);
      showNotification('No se pudo enviar el pedido', 'crimson');
    }finally{ sendOrderBtn.disabled = false; }
  });
}

/* ===========================
   Category buttons handlers
   =========================== */
document.getElementById('btnDrink').addEventListener('click', ()=>{
  currentCategory = 'drink';
  document.getElementById('btnDrink').classList.add('active');
  document.getElementById('btnFood').classList.remove('active');
  renderSubcategories();
  renderProducts();
});
document.getElementById('btnFood').addEventListener('click', ()=>{
  currentCategory = 'food';
  document.getElementById('btnFood').classList.add('active');
  document.getElementById('btnDrink').classList.remove('active');
  renderSubcategories();
  renderProducts();
});

/* initial render (if cached loaded earlier) */
renderSubcategories();
renderProducts();
</script>
</body>
</html>
